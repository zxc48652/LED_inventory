
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LED åº«å­˜ç®¡ç†è¡¨å–®</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
body { 
  margin: 0;
  font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: linear-gradient(to bottom right, #eef3f9, #dde6f1);
  color: #2c3e50;
}
.container { 
  display: flex; 
  gap: 20px; /*è®“sidebarè·Ÿä¸»å…§å®¹æœ‰é–“è·*/
  padding-top: 20px;
}
.sidebar { 
  width: 180px;
  background: linear-gradient(to bottom left, #1d3557, #2a9d8f);
  color: #fff;
  padding: 20px 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  margin-left: 20px;
}
.sidebar .title {
  font-size: 18px;
  font-weight: 700;
}
.sidebar button { /*å´é‚ŠæŒ‰éˆ•*/
  width: 160px; /*å¯¬åº¦*/
  height: 48px; /*é«˜åº¦*/
  margin-bottom: 15px; /*è®“å´é‚ŠæŒ‰éˆ•æœ‰é–“è·*/
  padding: 10px 16px; /*å…§è·*/
  font-size: 16px;
  border-radius: 10px;
  background-color: #1abc9c;
  color: white;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s ease, transform 0.2s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}
.sidebar button:hover {
  background-color: #16a085;
  transform: translateY(-2px);
}
#printButton {
  background-color: #ffffff;
  color: #2c3e50;
  border: 2px solid #2c3e50;
  font-weight: bold;
  transition: background-color 0.3s ease, color 0.3s ease;
}
#printButton:hover {
  background-color: #f2f2f2;
  color: #000;
}

.main { /*å´é‚Šä¸»å€å¡Š*/
  flex: 1;
  padding: 0 30px 30px 30px; 
  background-color: #f7f9fb;
}
.section { 
  background: #fff; 
  padding: 24px; 
  margin-bottom: 40px; 
  border-radius: 12px; 
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05); 
  border-left: 6px solid #3498db; /*è®“æ¯å€‹sectionæœ‰å·¦å´è—è‰²æ¢*/
}
.section h3 { 
  margin-top: 0; 
  margin-bottom: 16px;
  color: #2c3e50;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid #dce3e8;
  padding-bottom: 4px;
}
table { width: 100%; border-collapse: collapse; margin-top: 12px; }
table th, table td { border: 1px solid #dce3e8; padding: 8px; text-align: center; }
table th { background-color: #eaf3fb; font-weight: 600; }
input, select, textarea { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
input[type="date"] { 
  height: 30px;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 6px; 
  border: 1px solid #ccc;
  text-align: center;
}
textarea { resize: vertical; }
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; font-size: 18px; color: #2c3e50; }
.spinner { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner { width: 18px; height: 18px; border: 3px solid #fff; border-top: 3px solid #3498db; border-radius: 50%;animation: spin 1s linear infinite; } 
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.submit-btn, .submit-purchase-btn {
  background-color: #2ecc71;
  color: #fff;
  border: none;
  padding: 14px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px; /* æŒ‰éˆ•æ–‡å­—è·Ÿå°åœˆåœˆçš„è·é›¢ */
  min-width: 180px; /*å›ºå®šæœ€å°å¯¬åº¦*/
  text-align: center;/*ç½®ä¸­*/
  margin-top: 20px;
  transition: background-color 0.3s ease;
}
.submit-btn:hover, .submit-purchase-btn:hover {
  background-color: #27ae60;
}



.submit-btn .spinner,
.submit-purchase-btn .spinner {
  width: 16px;
  height: 16px;
  border: 3px solid #fff;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid #fff;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#purchaseListTable th,#purchaseListTable td {
  padding: 8px;
  text-align: center;
}
#purchaseListTable th {
  background-color: #f0f8ff;
}
.form-header {
  background: linear-gradient(to left, #1d3557, #2a9d8f);
  color: white;
  padding: 20px;
  border-radius: 12px 12px 0 0; 
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
  text-align: center;
}
.form-header h2 {
  margin: 0;
  font-size: 24px;
  font-weight: bold;
  color: #90f7ec;
}
.form-header p {
  margin-top: 6px;
  font-size: 14px;
  color: #d0e7e5;
}
.led-sent {
  background-color: #e0f7e9;
}

</style>
</head>
<body>
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>è³‡æ–™è¼‰å…¥ä¸­...</div>
</div>
<div class="form-header">
  <h2>ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</h2>
  <p>ğŸ“‹ LED é€²éŠ·å­˜è¡¨å–®</p>
</div>
<div class="container">
  <div class="sidebar">
    <button id="newOrderButton" class="blue-button">ğŸ”„ æ–°è¨‚å–®</button>
    <button id="printButton" onclick="printPurchaseOrder()">ğŸ–¨ï¸ åˆ—å°æ¡è³¼å–®</button>
    <button id="clearPurchaseListButton" class="blue-button">æ¸…ç©ºæ¡è³¼æ¸…å–®</button>
    <button onclick="showForm()">ğŸ“ LED è¡¨å–®</button>
    <button onclick="showQuery()">ğŸ” è¨‚å–®æŸ¥è©¢</button>
  </div>
  <div class="main">
    <div id="formSection" style="display: block;">
    <form id="mainForm">
      <div class="section">
        <h3>ğŸ”§ éŠ·è²¨ç™»éŒ„</h3>
        <table class="form-table">
          <tr>
            <th style="width: 10%;">æ—¥æœŸ</th>
            <th style="width: 40%;">æ©Ÿç¨®</th>
            <th style="width: 20%;">è¨‚å–®æ•¸é‡</th>
            <th style="width: 30%;">å®¢æˆ¶è¨‚å–®è™Ÿç¢¼</th>
          </tr>
          <tr>
            <td><input type="date" id="date_field"></td>
            <td><select id="model_select" required><option value="">è«‹é¸æ“‡æ©Ÿç¨®</option></select></td>
            <td><input type="number" id="order_qty" min="1" style="text-align: center;"></td>
            <td><input type="text" id="customer_order_no" required></td>
          </tr>
        </table>
        <button class="submit-btn" type="submit">
            <span class="spinner" style="display: none; margin-right: 6px;"></span>
            <span id="submitText">é€å‡ºéŠ·è²¨ç´€éŒ„</span>
        </button>
      </div>
    </form>

    <div class="section">
      <h3>ğŸ“¦ å°æ‡‰LEDæ¸…å–®</h3>
      <div id="ledListArea"></div>
    </div>

    <div class="section">
      <h3>ğŸ“‹ LEDæ¡è³¼è³‡æ–™</h3>
      <table class="form-table">
        <tr>
          <th style="width: 18%;">LEDå“è™Ÿ</th>
          <th style="width: 30%;">æ¡è³¼è³‡æ–™</th>
          <th style="width: 8%;">å–®åƒ¹</th>
          <th style="width: 12%;">ç•¶å‰åº«å­˜</th>
          <th style="width: 12%;">æ¡è³¼æ•¸é‡</th>
          <th style="width: 20%;">å‚™è¨»</th>
        </tr>
        <tr>
          <td><select id="purchase_led_select"><option value="">è«‹é¸æ“‡LEDå“è™Ÿ</option></select></td>
          <td id="purchase_info" style="padding: 8px;"></td>
          <td id="unit_price" style="text-align: center; padding: 8px;"></td>
          <td id="current_stock" style="text-align: center; padding: 8px;"></td>
          <td><input type="number" id="purchase_qty" style="text-align: center;"></td>
          <td><input type="text" id="purchase_remark"></td>
        </tr>
      </table>
    <button class="submit-purchase-btn" type="button">
      <div class="spinner" style="display: none;"></div>
        <span id="purchaseText">é€å‡ºLEDæ¡è³¼ç´€éŒ„</span>
    </button>
    </div>
    
    <div class="section">
      <h3>ğŸ“ æœ¬æ¬¡æ¡è³¼æ¸…å–®</h3>
      <h4 style="display: inline-flex; align-items: center; gap: 10px; margin: 8px 0;">
        <span style="white-space: nowrap;">è¨‚å–®è™Ÿç¢¼ï¼š</span>
        <input type="text" id="purchase_order_id" placeholder="" style="flex: 0 0 240px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px;"/>
      </h4> 
      <table id="purchaseListTable" class="form-table">
        <thead>
          <tr>
            <th>é¸å–</th>
            <th>LEDå“è™Ÿ</th>
            <th>æ¡è³¼è³‡æ–™</th>
            <th>å–®åƒ¹</th>
            <th>æ¡è³¼æ•¸é‡</th>
            <th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody id="purchaseListBody">
        </tbody>
      </table>
    </div>
    </div>
  <div id="querySection" style="display: none">
    <h2 style="text-align: center;">ğŸ“‹ è¨‚å–®æŸ¥è©¢</h2>
    <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 12px;">
      <input type="date" id="startDate" style="width: 300px; padding: 4px 6px; font-size: 14px;">
      <input type="date" id="endDate" style="width: 300px; padding: 4px 6px; font-size: 14px;">
      <input type="text" id="queryInput" placeholder="è¼¸å…¥æ©Ÿç¨®æˆ–LEDå“è™Ÿ" style="width: 400px; padding: 6px 10px; font-size: 15px;">
      <button onclick="searchOrders()" style="padding: 6px 18px; font-size: 16px;">æŸ¥è©¢</button>
    </div>
    <table id="queryResultTable" style="width: 100%; border-collapse: collapse;" border="1">
      <thead style="background-color: #eef3f9;">
        <tr>
          <th>æ—¥æœŸ</th><th>æ©Ÿç¨®</th><th>è¨‚å–®æ•¸é‡</th><th>LEDå“è™Ÿ</th><th>LEDç”¨é‡</th>
          <th>LEDç¸½ç”¨é‡</th><th>å®¢æˆ¶è¨‚å–®è™Ÿç¢¼</th><th>å‚™è¨»</th><th>åˆ°è²¨æ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody id="queryResultBody"></tbody>
    </table>
  </div>
  </div>
</div>
<script>
let modelData = {};
let ledData = {};

function loadModelData(selectedLedFromSubmit = null) {
  const selectedModelBeforeReload = document.getElementById("model_select").value; //è¨˜ä½é‡æ–°è¼‰å…¥å‰æ‰€é¸æ“‡çš„æ©Ÿç¨®

  fetch("https://script.google.com/macros/s/AKfycby3AAHIkvncufBGGv4j_mU3fqh4iWKLYz9zwovWj_nv20gbVc8-gXOuLj8jH89zcGFW/exec")
    .then(res => res.json())
    .then(data => {
      modelData = data.modelData;
      ledData = data.ledData;

      const modelSelect = document.getElementById("model_select");
      modelSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ©Ÿç¨®</option>';
      Object.keys(modelData).forEach(model => {
        const option = document.createElement("option");
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
      });
      $('#model_select').select2({ placeholder: "è«‹é¸æ“‡æ©Ÿç¨®", width: '100%' });
      $('#model_select').on('change', function() { updateLedList(this.value); });
      document.getElementById("order_qty").addEventListener('input', function() {
        updateLedList(document.getElementById("model_select").value);
      });
      //LEDå“è™Ÿé¸å–®
      const ledSelect = document.getElementById("purchase_led_select");
      ledSelect.innerHTML = '<option value="">è«‹é¸æ“‡LEDå“è™Ÿ</option>';
      Object.keys(ledData).forEach(ledId => {
        const option = document.createElement("option");
        option.value = ledId;
        option.textContent = ledId;
        ledSelect.appendChild(option);
      });
      $('#purchase_led_select')
      .select2({ placeholder: "è«‹é¸æ“‡LEDå“è™Ÿ", width: '100%' })
      .on('change',function(){
        updatePurchaseInfo(this.value);
      });
      const selectedLedBeforeReload = selectedLedFromSubmit || document.getElementById('purchase_led_select').value;
      //æ¢å¾©é€å‡ºå‰é¸çš„æ©Ÿç¨®
      if (selectedModelBeforeReload){
        $('#model_select').val(selectedModelBeforeReload).trigger('change');
      }
      //æ¢å¾©é€å‡ºå‰é¸çš„LEDå“è™Ÿ
      if (selectedLedBeforeReload){
        $('#purchase_led_select').val(selectedLedBeforeReload).trigger('change');
        updatePurchaseInfo(selectedLedBeforeReload);
      }
    })
    .catch(error => {
      alert("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š" + error);
    })
    .finally(() => {
      document.getElementById("loadingOverlay").style.display = "none";
    });
}

function updateLedList(selectedModel) {
  const area = document.getElementById("ledListArea");
  area.innerHTML = "";

  if (modelData[selectedModel]) {
    const orderQty = parseInt(document.getElementById("order_qty").value) || 0;
    let table = "<table><thead><tr><th>LEDå“è™Ÿ</th><th>å–®ä½ç”¨é‡</th><th>ç¸½ç”¨é‡</th><th>ç›®å‰åº«å­˜é‡</th><th>åº«å­˜ç‹€æ…‹</th><th>å‚™è¨»</th></tr></thead><tbody>";

    modelData[selectedModel].forEach(item => {
      const totalUsage = item.usage * orderQty;
      const isInsufficient = totalUsage > item.stock;
      const rowStyle = isInsufficient ? 'style="background-color:#fff3cd;"' : "";
      const remarkValue = isInsufficient ? `âš ï¸ ç¼º ${totalUsage - item.stock}` : "";
      const remarkStyle = isInsufficient ? 'style="color: red;"' : '';

      table += `<tr ${rowStyle}>
        <td onclick="selectPurchaseLed('${item.led_id}')" style="cursor:pointer; color:#3498db;">${item.led_id}</td> 
        <td>${item.usage}</td>
        <td>${totalUsage}</td>
        <td>${item.stock}</td>
        <td style="color: red; font-weight: bold;">${remarkValue}</td>
        <td>
          <select name="remarkSelect" onchange="handleRemarkChange(this)">
            <option value=""></option>
            <option value="æ°¸ä¸äº¨">æ°¸ä¸äº¨</option>
            <option value="åç ”">åç ”</option>
            <option value="ç›Šé´»">ç›Šé´»</option>
            <option value="æ•ç¿”">æ•ç¿”</option>
            <option value="ç¿Œå‡">ç¿Œå‡</option>
            <option value="æ¹§æ—º">æ¹§æ—º</option>
            <option value="ç·¯æ°">ç·¯æ°</option>
            <option value="é–±é †">é–±é †</option>
            <option value="æ ¼ç¢©">æ ¼ç¢©</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
          <input type="text" name="remarkInput" placeholder="è«‹è¼¸å…¥å‚™è¨»å…§å®¹" style="display:none; margin-top:6px;" />
        </td>
        </tr>`;
    });
    table += "</tbody></table>";
    area.innerHTML = table;
  }
}
//é€™ä¸€æ®µæ˜¯é»é¸LEDå“è™Ÿï¼Œè‡ªå‹•å¸¶å…¥
function selectPurchaseLed(ledId){
  $('#purchase_led_select').val(ledId).trigger('change');
}

function updatePurchaseInfo(ledId) {
  if (ledData[ledId]) {
    document.getElementById('purchase_info').textContent = ledData[ledId].purchaseInfo || "";
    document.getElementById('unit_price').textContent = ledData[ledId].unitPrice || "";
    document.getElementById('current_stock').textContent = (ledData[ledId].stock != null) ? ledData[ledId].stock : "";
  } else {
    document.getElementById('purchase_info').textContent = "";
    document.getElementById('unit_price').textContent = "";
    document.getElementById('current_stock').textContent = "";
  }
}

window.onload = function() {
  const today = new Date();
  const oneMonthAgo = new Date();
  oneMonthAgo.setDate(today.getDate());
  oneMonthAgo.setMonth(today.getMonth() -1);
  const todayStr = today.toISOString().split("T")[0];
  const oneMonthAgoStr = oneMonthAgo.toISOString().split("T")[0];
  document.getElementById("startDate").value = oneMonthAgoStr;
  document.getElementById("endDate").value = todayStr;
  document.getElementById('date_field').value = today.toISOString().substr(0, 10);
  loadModelData();
};

//é€å‡ºéŠ·è²¨ç´€éŒ„
const form = document.getElementById('mainForm');

form.addEventListener('submit', function(e) {
  e.preventDefault(); // é˜²æ­¢ç›´æ¥è·³è½‰
  const submitButton = document.querySelector('.submit-btn');
  submitButton.disabled = true;
  submitButton.querySelector('.spinner').style.display = "inline-block";
  document.getElementById('submitText').textContent = "é€å‡ºä¸­...";

  const date = document.getElementById('date_field').value;
  const model = document.getElementById('model_select').value;
  const orderQtyInput = document.getElementById('order_qty'); //æª¢æŸ¥è¨‚å–®æ•¸é‡æ˜¯æ­£æ•¸
  const orderQty = parseInt(orderQtyInput.value); 
  if (isNaN(orderQty) || orderQty <= 0) {
  alert("âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„è¨‚å–®æ•¸é‡ï¼ˆéœ€ç‚ºæ­£æ•´æ•¸ï¼‰ï¼");
  submitButton.disabled = false;
  submitButton.querySelector('.spinner').style.display = "none";
  document.getElementById('submitText').textContent = "é€å‡ºéŠ·è²¨ç´€éŒ„";
  return;
}
  const customerOrderNo = document.getElementById('customer_order_no').value;

  const ledListTable = document.querySelector('#ledListArea table tbody');
  const rows = ledListTable ? ledListTable.querySelectorAll('tr') : [];

  const records = [];

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const ledId = cells[0].innerText.trim();
    const ledUsage = parseInt(cells[1].innerText.trim()) || 0;
    const ledTotalUsage = parseInt(cells[2].innerText.trim()) || 0;
    const select = cells[5].querySelector('select[name="remarkSelect"]');
    const input = cells[5].querySelector('input[name=remarkInput]');
    const remark = (select.value === "å…¶ä»–" ? input.value.trim() : select.value);

    records.push({
      date: date,
      model: model,
      orderQty: orderQty,
      ledId: ledId,
      ledUsage: ledUsage,
      ledTotalUsage: ledTotalUsage,
      customerOrderNo: customerOrderNo,
      remark: remark
    });
  });

  if (records.length === 0) {
    alert("âŒ æ²’æœ‰è¦é€å‡ºçš„è³‡æ–™ï¼");
    submitButton.disabled = false;
    document.querySelector('#submitText .spinner').style.display = "none";
    document.getElementById('submitText').textContent = "é€å‡ºéŠ·è²¨ç´€éŒ„";
    return;
  }

  fetch("https://script.google.com/macros/s/AKfycbyVra2ephE6ZrwBpTX0VlIxuzZal_DVMsQZ26yKaCVbCrnp4SYMrQ-E_smT_AebgzUi/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ records: records })
  })
  .then(() => {
    alert("âœ… éŠ·è²¨ç´€éŒ„å·²é€å‡ºï¼");
    document.querySelector('#ledListArea table').classList.add('led-sent');
    submitButton.disabled = false;
    submitButton.querySelector('.spinner').style.display = "none";
    document.getElementById('submitText').textContent = 'é€å‡ºéŠ·è²¨ç´€éŒ„';
    const today = new Date(); //é‡è¨­ä»Šæ—¥æ—¥æœŸ
    document.getElementById('date_field').value = today.toISOString().substr(0,10);
    document.getElementById('order_qty').value = ''; //æ¸…ç©ºè¨‚å–®æ•¸é‡
    document.getElementById('customer_order_no').value = ''; //æ¸…ç©ºå®¢æˆ¶è¨‚å–®è™Ÿç¢¼
    loadModelData(); //é‡æ–°è¼‰å…¥è³‡æ–™
  })
  .catch(error => {
    alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error);
    submitButton.disabled = false;
    submitButton.querySelector('.spinner').style.display = "none";
    document.getElementById('submitText').textContent = 'é€å‡ºéŠ·è²¨ç´€éŒ„';
  });
});//é€å‡ºéŠ·è²¨ç´€éŒ„

//é»é¸æ–°è¨‚å–®æ¸…ç©ºè³‡æ–™
document.getElementById('newOrderButton').addEventListener('click',function() {
  //æ¸…ç©ºéŠ·è²¨æ¬„ä½
  document.getElementById('date_field').value = new Date().toISOString().substr(0,10);
  document.getElementById('model_select').value = '';
  $('#model_select').trigger('change');
  document.getElementById('order_qty').value = '';
  document.getElementById('customer_order_no').value = '';
  //æ¸…é™¤é¡è‰²
  const ledTable = document.querySelector('#ledListArea table');
  if (ledTable) ledTable.classList.remove('led-sent');
  //æ¸…ç©ºLEDæ¡è³¼æ¬„ä½
  document.getElementById('purchase_led_select').value = '';
  $('#purchase_led_select').trigger('change');
  document.getElementById('purchase_info').textContent = '';
  document.getElementById('unit_price').textContent = '';
  document.getElementById('current_stock').textContent = '';
  document.getElementById('purchase_qty').value = '';
  document.getElementById('purchase_remark').value = '';
  //æ¸…ç©ºå°æ‡‰LEDæ¸…å–®å€åŸŸ
  document.getElementById('ledListArea').innerHTML = '';
});//é»é¸æ–°è¨‚å–®æ¸…ç©ºè³‡æ–™

//å°æ‡‰LEDæ¸…å–®ï¼Œå‚™è¨»åˆ‡æ›è™•ç†
function handleRemarkChange(selectE1) {
  const input = selectE1.parentElement.querySelector('input[name="remarkInput"]');
  if (selectE1.value === 'å…¶ä»–') {
    input.style.display = 'block';
  } else {
    input.style.display = 'none';
    input.value = ''; //æ¸…ç©ºå…¶ä»–è¼¸å…¥æ¬„
  }
}

//é€å‡ºLEDæ¡è³¼ç´€éŒ„
const purchaseButton = document.querySelector('.submit-purchase-btn');

purchaseButton.addEventListener('click', function() {
  purchaseButton.disabled = true; //é€å‡ºå¾Œé–å®šæŒ‰éˆ•
  purchaseButton.querySelector('.spinner').style.display = "inline-block";
  document.getElementById('purchaseText').textContent = "é€å‡ºä¸­...";

  const date = document.getElementById('date_field').value; // è·ŸéŠ·è²¨ç™»éŒ„æ—¥æœŸåŒæ­¥
  const ledId = document.getElementById('purchase_led_select').value;
  const purchaseQty = parseInt(document.getElementById('purchase_qty').value) || 0;
  const remark = document.getElementById('purchase_remark').value.trim();

  if (!ledId || purchaseQty === 0) {
    alert("âŒ è«‹é¸æ“‡LEDå“è™Ÿä¸¦å¡«å¯«æ­£ç¢ºçš„æ¡è³¼æ•¸é‡ï¼");
    purchaseButton.disabled = false;
    purchaseButton.querySelector('.spinner').style.display = "none";
    document.getElementById('purchaseText').textContent = "é€å‡ºLEDæ¡è³¼ç´€éŒ„";
    return;
  }
  //å¦‚æœä½¿ç”¨è€…LEDæ¡è³¼è¼¸å…¥è² æ•¸ï¼Œè·³å‡ºç¢ºèªè¦–çª—
  if (purchaseQty < 0){
    const confirmNegative = confirm ("âš ï¸ ä½ è¼¸å…¥çš„æ˜¯è² æ•¸ï¼Œå°‡æ‰£é™¤åº«å­˜é‡ã€‚\nç¢ºå®šè¦ç¹¼çºŒé€å‡ºå—ï¼Ÿ");
    if (!confirmNegative) {
      purchaseButton.disabled = false;
      purchaseButton.querySelector('.spinner').style.display = "none";
      document.getElementById('purchaseText').textContent = "é€å‡ºLEDæ¡è³¼ç´€éŒ„";
      return; //å¦‚æœå–æ¶ˆï¼Œå°±ä¸é€å‡º
    }
  }

  const purchaseRecord = {
    date: date,
    ledId: ledId,
    purchaseQty: purchaseQty,
    remark: remark,
    lot: "",      // LOTæš«æ™‚ç•™ç©º(åˆ°è²¨å¾Œå¡«å…¥)
    rollCount: "" // æ²æ•¸æš«æ™‚ç•™ç©º(åˆ°è²¨å¾Œå¡«å…¥)
  };

  fetch("https://script.google.com/macros/s/AKfycbyQwPAeVt8DHYcaNiWveIMK63rP-7HaEJYy4sAwPX3vGYRXl9GE4tDCum_6GRW2RDTb/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(purchaseRecord)
  })
  .then(() => {
    alert("âœ… LEDæ¡è³¼ç´€éŒ„é€å‡ºæˆåŠŸï¼");
    //æ–°å¢åˆ°æœ¬æ¬¡é€å‡ºæ¸…å–®
    const purchaseListBody = document.getElementById('purchaseListBody');
    let foundRow = null;
    //åƒ…æ­£æ•¸é€²è¡Œç´¯åŠ 
    if (purchaseQty > 0) {
      const rows = purchaseListBody.querySelectorAll('tr');
      rows.forEach(row => {
        const ledCell = row.cells[1]; //ç¬¬äºŒæ¬„ï¼šå“è™Ÿ
        const qtyCell = row.cells[4]; //ç¬¬äº”æ¬„ï¼šæ•¸é‡
        if (ledCell && qtyCell) {
          const isNegative = parseInt(qtyCell.textContent.trim()) < 0;
          if (ledCell.textContent.trim() === ledId && !isNegative) {
            foundRow = row;
          }       
        }
      });
    }
    //æ‰¾åˆ°åŒå“è™Ÿä¸”ç‚ºæ­£æ•¸ï¼ˆç´¯åŠ ï¼‰
    if (foundRow) {
      const qtyCell = foundRow.cells[4];
      const originalQty = parseInt(qtyCell.textContent.trim());
      const newQty = originalQty + purchaseQty;
      qtyCell.textContent = newQty;
    } else {
      //æ²’æ‰¾åˆ° or è² æ•¸ï¼šæ–°å¢ä¸€åˆ—
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="checkbox" checked></td>
        <td>${ledId}</td>  
        <td>${document.getElementById('purchase_info').textContent}</td>
        <td>${document.getElementById('unit_price').textContent}</td>
        <td>${purchaseQty}</td>
        <td><input type="text" value="${remark}" class="remark-edit"></td>
      `;
      purchaseListBody.appendChild(newRow);
    }
    //æ–°å¢åˆ°æœ¬æ¬¡é€å‡ºæ¸…å–®

    purchaseButton.disabled = false;
    purchaseButton.querySelector('.spinner').style.display = "none";
    document.getElementById('purchaseText').textContent = "é€å‡ºLEDæ¡è³¼ç´€éŒ„";
    const selectedLedBeforeReload = document.getElementById('purchase_led_select').value; //è¨˜ä½LEDå“è™Ÿ
    loadModelData(selectedLedBeforeReload); //é‡æ–°è¼‰å…¥è³‡æ–™ï¼Œä¸¦æŠŠLEDå“è™Ÿå‚³é€²å»
    document.getElementById('purchase_qty').value = ""; //æ¸…ç©ºæ¡è³¼æ•¸é‡
    document.getElementById('purchase_remark').value = ""; //æ¸…ç©ºå‚™è¨»
  })
  .catch(error => {
    alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error);
    purchaseButton.disabled = false;
    purchaseButton.innerHTML = 'é€å‡ºæ¡è³¼ç´€éŒ„';
  });
});//é€å‡ºLEDæ¡è³¼ç´€éŒ„

//åˆ‡æ›LEDè¡¨å–® & è¨‚å–®æŸ¥è©¢
function showForm() {
  document.getElementById("formSection").style.display = "block";
  document.getElementById("querySection").style.display = "none";
}
function showQuery() {
  document.getElementById("formSection").style.display = "none";
  document.getElementById("querySection").style.display = "block";
}
//æŸ¥è©¢è¨‚å–®åŠŸèƒ½
function searchOrders() {
  const keyword = document.getElementById("queryInput").value.trim().toLowerCase();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const resultBody = document.getElementById("queryResultBody");

  resultBody.innerHTML = "<tr><td colspan='9'>â³ æŸ¥è©¢ä¸­...</td></tr>";

  fetch(`https://script.google.com/macros/s/AKfycbwrJHw3bjv4DiaVVb0j6OlA1YmPnGQIh8kOIFOxLXufWZQ3Zfsq1CHLqCzMOtlt-jGo/exec?keyword=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        let filtered = data.records;

      if (startDate) {
        filtered = filtered.filter(r => r.date && r.date.slice(0, 10) >= startDate);
      }
      if (endDate) {
        filtered = filtered.filter(r => r.date && r.date.slice(0, 10) <= endDate);
      }
        if (filtered.length === 0) {
          resultBody.innerHTML = "<tr><td colspan='9'>âŒ æŸ¥ç„¡è³‡æ–™</td></tr>";
          return;
        }

        resultBody.innerHTML = "";
        filtered.forEach(row => {
          const dateStr = row.date ? row.date.slice(0, 10) : "";
          const arrivalStr = row.arrival ? row.arrival.slice(0, 10) : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${dateStr}</td><td>${row.model}</td><td>${row.orderQty}</td>
            <td>${row.ledId}</td><td>${row.ledUsage}</td><td>${row.ledTotal}</td>
            <td>${row.orderNo}</td><td>${row.remark}</td><td>${arrivalStr}</td>
          `;
          resultBody.appendChild(tr);
        });
      } else {
        resultBody.innerHTML = "<tr><td colspan='9'>âŒ æŸ¥è©¢å¤±æ•—</td></tr>";
      }
    })
    .catch(() => {
      resultBody.innerHTML = "<tr><td colspan='9'>âŒ è«‹æ±‚å¤±æ•—</td></tr>";
    });
}

//æ¡è³¼å–®åˆ—å°
function printPurchaseOrder() {
  const rows = document.querySelectorAll('#purchaseListBody tr');
  if (rows.length === 0) {
    alert("âŒ æ²’æœ‰å¯åˆ—å°çš„æ¡è³¼é …ç›®ï¼");
    return;
  }

  const printTableBody = document.getElementById("print_table_body");
  printTableBody.innerHTML = "";

  let total = 0;
  let index = 1;

  rows.forEach(row => {
    const checked = row.querySelector('input[type="checkbox"]').checked;
    if (!checked) return;

    const cells = row.querySelectorAll("td");
    const ledInfo = cells[2].textContent.trim();  //æŠ“LEDçš„æ¡è³¼è³‡æ–™
    let rawPriceText = cells[3].textContent.trim().replace(/[^\d.]/g, ''); //ç§»é™¤å–®åƒ¹éæ•¸å­—å­—å…ƒ
    const unitPrice = parseFloat(rawPriceText) || 0;
    const qty = parseInt(cells[4].textContent.trim()) || 0;
    const remarkInput = cells[5].querySelector("input");
    const remark = remarkInput ? remarkInput.value.trim() : "";
    const subtotal = unitPrice * qty;
    total += subtotal;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center;">${index++}</td>
      <td>${ledInfo}</td>
      <td style="text-align:right;">${qty}</td>
      <td style="text-align:right;">$${unitPrice.toFixed(2)}</td>
      <td style="text-align:right;">$${subtotal.toFixed(2)}</td>
      <td style="text-align:center;">${remark}</td>
    `;
    printTableBody.appendChild(tr);
  });
  
  if (index === 1) {
    alert("âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€é …è¦åˆ—å°çš„è³‡æ–™ï¼");
    return;
  }
  //è¨­å®šæ¨™é ­è³‡è¨Š
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  const userOrderId = document.getElementById("purchase_order_id").value.trim(); //ä½¿ç”¨è€…è¼¸å…¥çš„è¨‚å–®è™Ÿç¢¼
  const dueStr = new Date(today.setDate(today.getDate() + 7 )).toISOString().slice(0,10);

  document.getElementById("print_date").textContent = todayStr;
  document.getElementById("print_order_id").textContent = userOrderId;
  document.getElementById("print_due_date").textContent = dueStr;
  document.getElementById("print_total").textContent = `$${total.toFixed(2)}`;

  //é¡¯ç¤ºåˆ—å°å€åŸŸ
  const printContent = document.getElementById("printSection").innerHTML;
  const printWindow = window.open("","_blank","width=850,height=1200");
  printWindow.document.write(`<html><head><title>LED æ¡è³¼å–®</title></head><body>${printContent}</body></html>`);
  printWindow.document.close();
  printWindow.print();
}//æ¡è³¼å–®åˆ—å°

//æ¸…ç©ºæ¡è³¼æ¸…å–®
document.getElementById("clearPurchaseListButton").addEventListener("click", function() {
  const confirmClear = confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ•´ä»½æœ¬æ¬¡æ¡è³¼æ¸…å–®å—ï¼Ÿ");
  if (confirmClear) {
    document.getElementById("purchaseListBody").innerHTML = "";
  }
});//æ¸…ç©ºæ¡è³¼æ¸…å–®

</script>

<div id="printSection" style="display: none;">
  <div style="width: 794px; margin: auto; font-family: 'PMingLiU', 'æ¨™æ¥·é«”', serif; font-size: 18px; color: #000; position: relative; height: 1120px;">
    <h2 style="text-align: center;">ç‘é´»é›»å­æœ‰é™å…¬å¸</h2>
    <p style="text-align: center;">å°å—å¸‚é—œå»Ÿå€ç”°ä¸­é‡Œå—é›„å—è·¯531è™Ÿ<br>é›»è©±ï¼š06-5551667 å‚³çœŸï¼š06-5552301<br>E-mail: a065551667@yahoo.com.tw</p>
    <hr>
    <h3 style="text-align: center;">æ¡è³¼å–®</h3>
    <table style="width: 100%; margin-top: 12px;">
      <p>å» å•†åç¨±ï¼šæ•å¾—è‚¡ä»½æœ‰é™å…¬å¸</p>
      <p>å‚³çœŸï¼š06-2794830</p>
      <p>é›»è©±ï¼š06-2794825   é™³å…ˆç”Ÿï¼š0932-032650</p>
    </table>
   
    <p>æ—¥æœŸï¼š<span id="print_date"></span></p>
    <p>è¨‚å–®è™Ÿç¢¼ï¼š<span id="print_order_id"></span></p>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;" border="1">
      <thead>
        <tr style="background:#eee; text-align: center;">
          <th>åº</th>
          <th>å“å/è¦æ ¼/é¡è‰²</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>ç¸½é‡‘é¡</th>
          <th>å‚™è¨»BIN</th>
        </tr>
      </thead>
      <tbody id="print_table_body"></tbody>
    </table>
    
    <p style="text-align: right;">åˆè¨ˆï¼š<span id="print_total"></span></p>
    
    <p>å» å•†äº¤æœŸï¼š<span id="print_due_date"></span> å‰</p>
    <p>å‚™è¨»ï¼šè²¨å¥½å¯å…ˆå‡º / LEDè«‹çš†çµ¦BIN ä¸è¦æ··BIN</p>
    <p>å¦‚ç„¡å›è¦†ï¼Œè¦–åŒå¯å¦‚æœŸäº¤è²¨</p>

    <table style="position: absolute; bottom: 0; width: 100%; border-top: 1px dashed #ccc; padding-top: 12px;">
      <tr>
        <td style="width: 33%;">é€²è²¨æª¢é©—ä¾æ“šï¼š</td>
        <td style="width: 33%;">æŠ½é©—æ°´æº–ï¼š</td>
        <td style="width: 34%;"></td>
      </tr>
      <tr><td colspan="3" style="padding-top: 10px;">äº¤è²¨åœ°é»ï¼šç‘é‘«</td></tr>
      <tr><td colspan="3">åŒ…è£æ–¹å¼ï¼š</td></tr>
      <tr><td colspan="3">çµ±ç·¨ï¼š82878750</td></tr>
      <tr>
        <td style="padding-top: 30px; text-align: left;">å» å•†ç¢ºèªç°½å›ï¼š</td>
        <td style="padding-top: 30px; text-align: center;">æ ¸å‡†ï¼š</td>
        <td style="padding-top: 30px; text-align: right; padding-right: 100px;">è£½è¡¨ï¼š</td>
      </tr>
    </table>
  </div>
</div>

</body>
</html>